
var URL_FRAMEWORK="index.cfm/framework/getJsonAllREsults/";
var URL_ACTIVITY_JSON="index.cfm/framework/getJsonactivity/activityID/"
var URL_INDICATOR_JSON="index.cfm/framework/getJsonindicator/indicatorID/"
var RF=function(){var w=1280,h=2500,i=0,barHeight=35,barWidth=w*.7,duration=400,root;var tree=d3.layout.tree().size([h,w/20]);var diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x];});var svg,vis;function visualizeTree(treeObj){root=treeObj;svg=d3.select("#chart").append("svg:svg").attr("width",w).attr("height",h);vis=svg.append("svg:g").attr("transform","translate(20,30)");vis.append("rect").attr("class","box").attr("x",-20).attr("y",-30).attr("width",w).attr("height",h);treeObj.x0=0;treeObj.y0=0;function collapse(d){if(d.children){d._children=d.children;d._children.forEach(collapse);d.children=null;}}
if(treeObj.children){treeObj.children.forEach(collapse);}
update(treeObj);}
function frameworkTree(json,noChildren){var allElements=json['FullFramework'];var allElementsMap={};var i;var keys;var treeObj;if(allElements&&allElements.length){allElements.forEach(function(element){i=element.RESULTSFRAMEWORKELEMENTID;allElementsMap[i]=element;});keys=Object.keys(allElementsMap);keys=keys.sort(function(a,b){return a-b;});function treeNode(i){var node={};var indicators;jQuery.extend(node,allElementsMap[i]);function loadObjects(baseURL,idxArray){var objArray;if(idxArray&&idxArray.length){objArray=idxArray.map(function(id,i,arr){var a={};if((typeof id)==='number'){loadJSON(baseURL+id).done(function(data){jQuery.extend(a,data);});}
return a;});}
return objArray;}
if(!noChildren){node.Activities=loadObjects(URL_ACTIVITY_JSON,node.Activities);node.Indicators=loadObjects(URL_INDICATOR_JSON,node.Indicators);}
if(node.Children&&node.Children.length){node.children=node.Children.map(treeNode);}
delete node.Children;return node;}
treeObj=treeNode(keys[0]);return treeObj;}else{throw new Error("Unable to parse json:",json);}}
function update(source){var nodes=tree.nodes(root);h=nodes.length*barHeight+50;svg.attr("height",h);svg.select(".box").attr("height",h);nodes.forEach(function(n,i){n.x=i*barHeight;});var node=vis.selectAll("g.node").data(nodes,function(d){return d.id||(d.id=++i);});var nodeEnter=node.enter().append("svg:g").attr("class","node").attr("transform",function(d){return"translate("+source.y0+","+source.x0+")";}).style("opacity",1e-6);nodeEnter.append("svg:rect").attr("y",-barHeight/2).attr("height",barHeight-4).attr("width",barWidth).style("fill",color).on("click",click);nodeEnter.append("svg:text").attr("dy",3.5).attr("dx",5.5).text(function(d){return d.NAME;});var withActivity=nodeEnter.filter(function(d,i){return d.Activities&&d.Activities.length?this:null});var withIndicator=nodeEnter.filter(function(d,i){return d.Indicators&&d.Indicators.length?this:null});withActivity.append("svg:circle").attr("class","activity").attr("cx",barWidth-12).attr("cy",-2).attr("r",10).style("fill-opacity",0.5).on("click",dspActivities);withActivity.append("svg:text").attr("dx",barWidth-15).attr("dy",3.5).text(function(d){return d.Activities.length;});withIndicator.append("svg:circle").attr("class","indicator").attr("cx",barWidth-36).attr("cy",-2).attr("r",10).style("fill-opacity",0.5).on("click",dspIndicators);withIndicator.append("svg:text").attr("dx",barWidth-39).attr("dy",3.5).text(function(d){return d.Indicators.length;});nodeEnter.transition().duration(duration).attr("transform",function(d){return"translate("+d.y+","+d.x+")";}).style("opacity",1);node.transition().duration(duration).attr("transform",function(d){return"translate("+d.y+","+d.x+")";}).style("opacity",1).select("rect").style("fill",color);node.exit().transition().duration(duration).attr("transform",function(d){return"translate("+source.y+","+source.x+")";}).style("opacity",1e-6).remove();var link=vis.selectAll("path.link").data(tree.links(nodes),function(d){return d.target.id;});link.enter().insert("svg:path","g").attr("class","link").attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o});}).transition().duration(duration).attr("d",diagonal);link.transition().duration(duration).attr("d",diagonal);link.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x,y:source.y};return diagonal({source:o,target:o});}).remove();nodes.forEach(function(d){d.x0=d.x;d.y0=d.y;});}
function dspActivities(d,i){var names=d.Activities.map(function(a){return a.ACTIVITYID+":\t"+a.NAME;});window.alert(names.join("\n"));}
function dspIndicators(d,i){var names=d.Indicators.map(function(a){return a.INDICATORID+":\t"+a.NAME;});window.alert(names.join("\n"));}
function click(d,i){if(d.children){d._children=d.children;d.children=null;}else{d.children=d._children;d._children=null;}
console.log(d.RESULTSFRAMEWORKELEMENTID,d);update(d);}
function color(d){return d._children?"#3182bd":d.children?"#c6dbef":"#fd8d3c";}
$.ajaxSetup({xhrFields:{withCredentials:true}});function loadJSON(url){return $.ajax(url).fail(function(jqXHR,textStatus,errorThrown){message="Failed to load: '"+url+"'";console.log(message);
/* window.alert("Login first, then reload this page."); */
});}
return{color:color,loadJSON:loadJSON,frameworkTree:frameworkTree,visualizeFramework:function(url){loadJSON(url).done(function(data){root=frameworkTree(data);visualizeTree(root);});},getTreeObj:function(){return root;},visualizeTree:visualizeTree}}();